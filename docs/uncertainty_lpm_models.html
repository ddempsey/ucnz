<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uncertainty - LPM Models</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { text-align: center; color: #333; }
        .explainer {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            line-height: 1.6;
        }
        .explainer p { margin: 1em 0; }
        .widget-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label { font-weight: 500; }
        .control-group input[type="range"] { width: 180px; }
        .canvas-container { display: flex; justify-content: center; }
        canvas { border: 1px solid #ddd; background: white; max-width: 100%; }
        .questions {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            line-height: 1.8;
        }
        .questions p { margin: 0.8em 0; color: #555; }
    </style>
</head>
<body>
    <h1>LPM Calibration</h1>

    <div class="explainer">
        <p>
            The lumped parameter model has been calibrated to the Wairakei pressure data.
            There is some uncertainty in the measured pressure data &mdash; reservoir engineers
            estimate the error variance could be as large as 2 bar. Thus, it seems reasonable
            that there are a range of models that could fit the data.
        </p>
        <p><strong>Move the sliders to determine acceptable ranges for \(a\), \(b\) and \(c\).</strong></p>
    </div>

    <div class="widget-container">
        <div class="controls">
            <div class="control-group">
                <label>\(a\):</label>
                <input type="range" id="aSlider" min="-27576" max="-25576" step="20" value="-26576">
                <span id="aVal" style="min-width:70px;">2.20e-3</span>
            </div>
            <div class="control-group">
                <label>\(b\):</label>
                <input type="range" id="bSlider" min="-10586" max="-8586" step="20" value="-9586">
                <span id="bVal" style="min-width:70px;">1.10e-1</span>
            </div>
            <div class="control-group">
                <label>\(c\):</label>
                <input type="range" id="cSlider" min="-26675" max="-16675" step="50" value="-21675">
                <span id="cVal" style="min-width:70px;">6.80e-3</span>
            </div>
        </div>
        <div class="canvas-container">
            <canvas id="canvas" width="800" height="450"></canvas>
        </div>
    </div>

    <div class="questions">
        <p>Move the slider bars to determine acceptable ranges for the parameters \(a\), \(b\) and \(c\).</p>
        <p>Set the slider bars to their original positions.</p>
        <p>Change \(a\) to 0.00264. Is this an acceptable model?</p>
        <p>Leave \(a\) as 0.00264 and change \(b\) to 0.132. Is this an acceptable model?</p>
        <p>Is \(a\) = 0.00264 a plausible parameter value? Justify your answer.</p>
    </div>

    <script>
        // ========== Data (first 28 points: 1953-1980) ==========
        const tq = [1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980];
        const q  = [0,91.97,142.23,243.53,369.64,435.35,386.3,799.44,1001.33,853.13,1279.4,1680.92,1734.78,1651.72,1611.03,1473.87,1342.67,1486.49,1445.96,1440.69,1372.32,1305.38,1256.35,1246.42,1221.76,1465.79,1371.32,1293.33];
        const tp = [1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980];
        const p  = [56.26,55.69,55.5,54.73,52.76,52.15,51.48,47.71,46.87,45.55,41.84,38.51,36.28,35.1,34.16,34.42,33.56,33.03,32.5,32,31.7,31.64,31.73,31.69,31.83,31.02,30.7,30.84];

        // Compute dq/dt (finite differences)
        const dqdt = new Array(tq.length).fill(0);
        dqdt[0] = (q[1] - q[0]) / (tq[1] - tq[0]);
        for (let i = 1; i < tq.length - 1; i++) {
            dqdt[i] = (q[i + 1] - q[i - 1]) / (tq[i + 1] - tq[i - 1]);
        }
        dqdt[tq.length - 1] = (q[tq.length - 1] - q[tq.length - 2]) / (tq[tq.length - 1] - tq[tq.length - 2]);

        // Linear interpolation
        function interp(t, xs, ys) {
            if (t <= xs[0]) return ys[0];
            if (t >= xs[xs.length - 1]) return ys[ys.length - 1];
            for (let i = 0; i < xs.length - 1; i++) {
                if (t >= xs[i] && t <= xs[i + 1]) {
                    const f = (t - xs[i]) / (xs[i + 1] - xs[i]);
                    return ys[i] + f * (ys[i + 1] - ys[i]);
                }
            }
            return ys[ys.length - 1];
        }

        // LPM derivative: dP/dt = -a*q - b*P - c*dq/dt
        function lpmDeriv(pi, t, a, b, c) {
            return -a * interp(t, tq, q) - b * pi - c * interp(t, tq, dqdt);
        }

        // Improved Euler solver
        function solveLPM(a, b, c) {
            const pm = [p[0]];
            for (let i = 0; i < tp.length - 1; i++) {
                const t0 = tp[i], t1 = tp[i + 1];
                const dt = t1 - t0;
                const dpdt1 = lpmDeriv(pm[i] - p[0], t0, a, b, c);
                const pp = pm[i] + dpdt1 * dt;
                const dpdt2 = lpmDeriv(pp - p[0], t1, a, b, c);
                pm.push(pm[i] + 0.5 * dt * (dpdt1 + dpdt2));
            }
            return pm;
        }

        // ========== Canvas setup ==========
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const cssW = 800, cssH = 450;
        canvas.width = cssW * dpr;
        canvas.height = cssH * dpr;
        canvas.style.width = cssW + 'px';
        canvas.style.height = cssH + 'px';
        ctx.scale(dpr, dpr);

        const mg = { left: 70, right: 25, top: 25, bottom: 60 };
        const plotW = cssW - mg.left - mg.right;
        const plotH = cssH - mg.top - mg.bottom;

        const tMin = 1952, tMax = 1981;
        const pMin = 25, pMax = 60;

        function txC(t) { return mg.left + (t - tMin) / (tMax - tMin) * plotW; }
        function tyC(v) { return mg.top + (pMax - v) / (pMax - pMin) * plotH; }

        // ========== Draw ==========
        function draw() {
            // Read log-scale slider values (stored as integer * 10000 for precision)
            const a = Math.pow(10, parseInt(document.getElementById('aSlider').value) / 10000);
            const b = Math.pow(10, parseInt(document.getElementById('bSlider').value) / 10000);
            const c = Math.pow(10, parseInt(document.getElementById('cSlider').value) / 10000);

            document.getElementById('aVal').textContent = a.toExponential(2);
            document.getElementById('bVal').textContent = b.toExponential(2);
            document.getElementById('cVal').textContent = c.toExponential(2);

            ctx.clearRect(0, 0, cssW, cssH);

            // Solve model
            const pm = solveLPM(a, b, c);

            // Clip
            ctx.save();
            ctx.beginPath();
            ctx.rect(mg.left, mg.top, plotW, plotH);
            ctx.clip();

            // Observations with error bars
            const v = 2;
            for (let i = 0; i < tp.length; i++) {
                const cx = txC(tp[i]), cy = tyC(p[i]);
                // Error bar
                ctx.strokeStyle = '#FF0000';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                ctx.moveTo(cx, tyC(p[i] - v));
                ctx.lineTo(cx, tyC(p[i] + v));
                ctx.stroke();
                // Point
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(cx, cy, 4, 0, 2 * Math.PI);
                ctx.fill();
            }

            // Model line
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < tp.length; i++) {
                const cx = txC(tp[i]), cy = tyC(pm[i]);
                if (i === 0) ctx.moveTo(cx, cy); else ctx.lineTo(cx, cy);
            }
            ctx.stroke();

            ctx.restore();

            // Axes
            drawAxes();

            // Legend
            const lx = mg.left + plotW - 175, ly = mg.top + 10;
            ctx.fillStyle = 'rgba(255,255,255,0.92)';
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.fillRect(lx, ly, 165, 56);
            ctx.strokeRect(lx, ly, 165, 56);
            ctx.font = '14px Segoe UI';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            // Observation legend
            ctx.fillStyle = '#FF0000';
            ctx.beginPath(); ctx.arc(lx + 15, ly + 16, 4, 0, 2 * Math.PI); ctx.fill();
            ctx.fillStyle = '#000';
            ctx.fillText('observations', lx + 30, ly + 16);
            // Model legend
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(lx + 5, ly + 40); ctx.lineTo(lx + 25, ly + 40); ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.fillText('model', lx + 30, ly + 40);
        }

        function drawAxes() {
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            ctx.strokeRect(mg.left, mg.top, plotW, plotH);

            ctx.fillStyle = '#000';
            ctx.font = '14px Segoe UI';

            // X ticks
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for (let t = 1955; t <= 1980; t += 5) {
                const cx = txC(t);
                ctx.beginPath(); ctx.moveTo(cx, mg.top + plotH); ctx.lineTo(cx, mg.top + plotH + 5); ctx.stroke();
                ctx.fillText(t.toString(), cx, mg.top + plotH + 8);
            }
            ctx.font = '15px Segoe UI';
            ctx.fillText('time [yr]', mg.left + plotW / 2, mg.top + plotH + 28);

            // Y ticks
            ctx.font = '14px Segoe UI';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let v = 25; v <= 60; v += 5) {
                const cy = tyC(v);
                ctx.beginPath(); ctx.moveTo(mg.left - 5, cy); ctx.lineTo(mg.left, cy); ctx.stroke();
                ctx.fillText(v.toString(), mg.left - 8, cy);
            }
            ctx.save();
            ctx.translate(18, mg.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.font = '15px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('pressure [bar]', 0, 0);
            ctx.restore();
        }

        // ========== Events ==========
        document.getElementById('aSlider').addEventListener('input', draw);
        document.getElementById('bSlider').addEventListener('input', draw);
        document.getElementById('cSlider').addEventListener('input', draw);
        draw();
    </script>
</body>
</html>
